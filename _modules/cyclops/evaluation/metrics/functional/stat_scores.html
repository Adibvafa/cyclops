<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cyclops.evaluation.metrics.functional.stat_scores &mdash; cyclops  documentation</title>
      <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/css/cyclops.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
<script type="text/javascript">
  window.onload = function() {
    document.body.innerHTML = document.body.innerHTML.replace(/ module/g, '');
  }
</script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #efeeed" >
            <a href="../../../../../index.html" class="icon icon-home"> cyclops
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html"># cyclops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html#getting-started">üê£ Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html#documentation">üìö Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html#notebooks">üéì Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../design.html">Framework Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../gemini_hpc.html">Using cyclops on the GEMINI HPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html">Contributing to cyclops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../coverage.html">Coverage report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #efeeed" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">cyclops</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
      <li>cyclops.evaluation.metrics.functional.stat_scores</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cyclops.evaluation.metrics.functional.stat_scores</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Functions for computing stat scores for different types of inputs.</span>

<span class="sd">The stat scores are the number of true positives, false positives, true negatives, and</span>
<span class="sd">false negatives. Binary, multiclass and multilabel data are supported, including logits</span>
<span class="sd">and probabilities.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">ArrayLike</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">multilabel_confusion_matrix</span>

<span class="kn">from</span> <span class="nn">cyclops.evaluation.metrics.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">check_topk</span><span class="p">,</span>
    <span class="n">common_input_checks_and_format</span><span class="p">,</span>
    <span class="n">select_topk</span><span class="p">,</span>
    <span class="n">sigmoid</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_stat_scores_update</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;multiclass&quot;</span><span class="p">,</span> <span class="s2">&quot;multilabel&quot;</span><span class="p">],</span>
    <span class="n">pos_label</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">classwise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reduce</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;samples&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;micro&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the stat scores for a given task.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        task: String</span>
<span class="sd">            The task type. Can be either &#39;binary&#39;, &#39;multiclass&#39; or &#39;multilabel&#39;.</span>
<span class="sd">        pos_label: int</span>
<span class="sd">            The positive label to report. Defaults to 1. Can be either 0, 1.</span>
<span class="sd">            Only applicable to binary data.</span>
<span class="sd">        num_classes: int</span>
<span class="sd">            The number of classes. Only used for multiclass tasks.</span>
<span class="sd">        num_labels: int</span>
<span class="sd">            The number of labels. Only used for multilabel tasks.</span>
<span class="sd">        sample_weight: ArrayLike</span>
<span class="sd">            Sample weights.</span>
<span class="sd">        classwise: bool</span>
<span class="sd">            Whether to compute the stat scores classwise. Defaults to False. Only</span>
<span class="sd">            used for multiclass tasks.</span>
<span class="sd">        reduce: String</span>
<span class="sd">            Reduction mode. Defaults to &#39;macro&#39;. One of:</span>
<span class="sd">            &#39;micro&#39;: sum the statistics over all samples and labels to compute the</span>
<span class="sd">                global score.</span>
<span class="sd">            &#39;macro&#39;: Calculate metrics for each label/class.</span>
<span class="sd">            &#39;samples&#39;: Calculate metrics for each instance/sample.</span>
<span class="sd">        threshold: float</span>
<span class="sd">            Threshold for binarizing the predictions. Defaults to 0.5. Only used</span>
<span class="sd">            for binary and multilabel tasks.</span>
<span class="sd">        top_k: int</span>
<span class="sd">            Number of top elements to look at for computing accuracy. Only used</span>
<span class="sd">            for multiclass and multilabel tasks.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The stat scores.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the task is not one of &#39;binary&#39;, &#39;multiclass&#39; or &#39;multilabel&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
        <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_binary_stat_scores_update</span><span class="p">(</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">preds</span><span class="p">,</span>
            <span class="n">pos_label</span><span class="o">=</span><span class="n">pos_label</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;multiclass&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">num_classes</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">&quot;Number of classes must be a positive integer.&quot;</span>
        <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_multiclass_stat_scores_update</span><span class="p">(</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">preds</span><span class="p">,</span>
            <span class="n">num_classes</span><span class="p">,</span>
            <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
            <span class="n">classwise</span><span class="o">=</span><span class="n">classwise</span><span class="p">,</span>
            <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;multilabel&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_labels</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">num_labels</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">&quot;Number of labels must be a positive integer.&quot;</span>
        <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_multilabel_stat_scores_update</span><span class="p">(</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">preds</span><span class="p">,</span>
            <span class="n">num_labels</span><span class="p">,</span>
            <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
            <span class="n">reduce</span><span class="o">=</span><span class="n">reduce</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported task: </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">, expected one of &#39;binary&#39;, &#39;multiclass&#39; or &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;multilabel&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span>


<span class="k">def</span> <span class="nf">_stat_scores</span><span class="p">(</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reduce</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;samples&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;micro&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Compute true positives, false positives, true negatives and false negatives.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        preds: np.ndarray</span>
<span class="sd">            Predictions.</span>
<span class="sd">        target: np.ndarray</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        sample_weight: np.ndarray</span>
<span class="sd">            Sample weights.</span>
<span class="sd">        labels: np.ndarray</span>
<span class="sd">            The set of labels to include.</span>
<span class="sd">        reduce: String</span>
<span class="sd">            Reduction mode. Defaults to &#39;micro&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The stat scores.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">samplewise</span> <span class="o">=</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;samples&quot;</span>
    <span class="n">confmat</span> <span class="o">=</span> <span class="n">multilabel_confusion_matrix</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">samplewise</span><span class="o">=</span><span class="n">samplewise</span>
    <span class="p">)</span>  <span class="c1"># shape: (num_outputs, 2, 2)</span>

    <span class="n">tn</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># shape: (num_outputs,)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">reduce</span> <span class="o">==</span> <span class="s2">&quot;micro&quot;</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">tn</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">tn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_stat_scores_compute</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">tp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute true positives, false positives, true negatives and false negatives.</span>

<span class="sd">    Concatenates the results in a single array, along with the support.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        tp: np.ndarray</span>
<span class="sd">            True positives.</span>
<span class="sd">        fp: np.ndarray</span>
<span class="sd">            False positives.</span>
<span class="sd">        tn: np.ndarray</span>
<span class="sd">            True negatives.</span>
<span class="sd">        fn: np.ndarray</span>
<span class="sd">            False negatives.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The stat scores.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># support</span>
    <span class="p">]</span>

    <span class="n">output</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>


<div class="viewcode-block" id="stat_scores"><a class="viewcode-back" href="../../../../../reference/api/cyclops.evaluation.metrics.functional.stat_scores.html#cyclops.evaluation.metrics.functional.stat_scores.stat_scores">[docs]</a><span class="k">def</span> <span class="nf">stat_scores</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;multiclass&quot;</span><span class="p">,</span> <span class="s2">&quot;multilabel&quot;</span><span class="p">],</span>
    <span class="n">pos_label</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">classwise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">num_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reduce</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;samples&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;micro&quot;</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute true positives, false positives, true negatives and false negatives.</span>

<span class="sd">    Concatenates the results in a single array, along with the support. This</span>
<span class="sd">    function acts as an entry point for more specialized functions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        task: String</span>
<span class="sd">            The task type. Can be either ``&quot;binary&quot;``, ``&quot;multiclass&quot;`` or</span>
<span class="sd">            ``&quot;multilabel&quot;``. One of:</span>
<span class="sd">                - ``&quot;binary&quot;``: binary classification.</span>
<span class="sd">                    Example: [0, 1, 1, 0, 1] or [0.1, 0.9, 0.8, 0.2, 0.4]</span>
<span class="sd">                - ``&quot;multiclass&quot;``: multiclass classification.</span>
<span class="sd">                    Example: [0, 1, 2, 0, 1] or [[0.1, 0.9, 0.0], [0.0, 0.8, 0.2], ...]</span>
<span class="sd">                - ``&quot;multilabel&quot;``: multilabel classification.</span>
<span class="sd">                    Example: [[0, 1], [1, 0], [1, 1], [0, 0], [1, 0]] or</span>
<span class="sd">                    [[0.1, 0.9], [0.0, 0.8], ...]</span>

<span class="sd">        pos_label: int</span>
<span class="sd">            The positive label. Defaults to 1. Only used for binary tasks.</span>
<span class="sd">        num_classes: int</span>
<span class="sd">            The number of classes. Only used for multiclass tasks.</span>
<span class="sd">        classwise: bool</span>
<span class="sd">            Whether to compute the stat scores classwise. Only used for multiclass</span>
<span class="sd">            tasks. Defaults to False.</span>
<span class="sd">        top_k: int</span>
<span class="sd">            The number of top classes to consider. Used for multiclass and</span>
<span class="sd">            multilabel tasks. Defaults to None.</span>
<span class="sd">        threshold: float</span>
<span class="sd">            The threshold to use for binarizing the predictions. Used for</span>
<span class="sd">            binary and multilabel tasks. Defaults to 0.5.</span>
<span class="sd">        num_labels: int</span>
<span class="sd">            The number of labels. Only used for multilabel tasks.</span>
<span class="sd">        reduce: Literal[&quot;micro&quot;, &quot;macro&quot;, &quot;samples&quot;]</span>
<span class="sd">            Reduction mode. Defaults to &#39;micro&#39;. Only used for multiclass and</span>
<span class="sd">            multilabel tasks. One of:</span>
<span class="sd">                - ``&quot;micro&quot;``: compute the stat scores globally.</span>
<span class="sd">                - ``&quot;macro&quot;``: compute the stat scores for each class.</span>
<span class="sd">                - ``&quot;samples&quot;``: compute the stat scores for each sample.</span>

<span class="sd">        sample_weight: ArrayLike</span>
<span class="sd">            Sample weights.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The stat scores.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_stat_scores_update</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">preds</span><span class="p">,</span>
        <span class="n">task</span><span class="p">,</span>
        <span class="n">pos_label</span><span class="o">=</span><span class="n">pos_label</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
        <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">,</span>
        <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
        <span class="n">classwise</span><span class="o">=</span><span class="n">classwise</span><span class="p">,</span>
        <span class="n">reduce</span><span class="o">=</span><span class="n">reduce</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
        <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">_stat_scores_compute</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_binary_stat_scores_format</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format the input for computing binary stat scores.</span>

<span class="sd">    Converts the target and preds to binary and checks the shape.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        threshold: float</span>
<span class="sd">            Threshold for converting logits and probability predictions to binary</span>
<span class="sd">            [1, 0].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The formatted target and preds.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the target and preds are not binary.</span>

<span class="sd">        RuntimeError</span>
<span class="sd">            If the target and preds have non-binary values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">type_target</span><span class="p">,</span> <span class="n">type_preds</span> <span class="o">=</span> <span class="n">common_input_checks_and_format</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">preds</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">type_target</span> <span class="o">!=</span> <span class="s2">&quot;binary&quot;</span> <span class="ow">or</span> <span class="n">type_preds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The arguments `target` and `preds` must be binary or continuous, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">type_target</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">type_preds</span><span class="si">}</span><span class="s2"> respectively.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># check the number of classes</span>
    <span class="n">unique_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">check</span> <span class="o">=</span> <span class="nb">any</span><span class="p">((</span><span class="n">unique_values</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">unique_values</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Detected the following values in `target`: </span><span class="si">{</span><span class="n">unique_values</span><span class="si">}</span><span class="s2"> but&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; expected only the following values </span><span class="si">{</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># If preds is label array, also check that it only contains [0,1] values</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">type_preds</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
        <span class="n">unique_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">unique_values</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">unique_values</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Detected the following values in `preds`: </span><span class="si">{</span><span class="n">unique_values</span><span class="si">}</span><span class="s2"> but&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; expected only [0,1] values since `preds` is a label array.&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">type_preds</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">preds</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">preds</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)):</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>  <span class="c1"># convert logits to probabilities</span>

        <span class="n">preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">preds</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_binary_stat_scores_update</span><span class="p">(</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">pos_label</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute the statistics for binary inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        pos_label: int</span>
<span class="sd">            The positive label to report. Defaults to 1. Can be either 0, 1.</span>
<span class="sd">        threshold: float</span>
<span class="sd">            Threshold for converting logits and probability predictions to binary</span>
<span class="sd">            [1, 0]. Defaults to 0.5.</span>
<span class="sd">        sample_weight: ArrayLike</span>
<span class="sd">            Sample weights.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The true positives, false positives, true negatives and false negatives.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the target and preds are not numeric.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">target</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">_binary_stat_scores_format</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pos_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The argument `pos_label` must be either 0 or 1, got </span><span class="si">{</span><span class="n">pos_label</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="n">confmat</span> <span class="o">=</span> <span class="n">multilabel_confusion_matrix</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">pos_label</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">tn</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">confmat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_binary_stat_scores_compute</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">tp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the stat scores for binary inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        tp: np.ndarray</span>
<span class="sd">            True positives.</span>
<span class="sd">        fp: np.ndarray</span>
<span class="sd">            False positives.</span>
<span class="sd">        tn: np.ndarray</span>
<span class="sd">            True negatives.</span>
<span class="sd">        fn: np.ndarray</span>
<span class="sd">            False negatives.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The stat scores.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_stat_scores_compute</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>


<div class="viewcode-block" id="binary_stat_scores"><a class="viewcode-back" href="../../../../../reference/api/cyclops.evaluation.metrics.functional.stat_scores.html#cyclops.evaluation.metrics.functional.stat_scores.binary_stat_scores">[docs]</a><span class="k">def</span> <span class="nf">binary_stat_scores</span><span class="p">(</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">pos_label</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute the stat scores for binary inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        pos_label: int</span>
<span class="sd">            The positive label to report. Defaults to 1. Can be either 0, 1.</span>
<span class="sd">        threshold: float</span>
<span class="sd">            Threshold for converting logits and probability predictions to binary</span>
<span class="sd">            [1, 0]. Defaults to 0.5.</span>
<span class="sd">        sample_weight: ArrayLike</span>
<span class="sd">            Sample weights.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The true positives, false positives, true negatives and false negatives.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If threshold is not a float and not in [0,1].</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected argument `threshold` to be a float in the [0,1] range, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_binary_stat_scores_update</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">preds</span><span class="p">,</span>
        <span class="n">pos_label</span><span class="o">=</span><span class="n">pos_label</span><span class="p">,</span>
        <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">_binary_stat_scores_compute</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_multiclass_stat_scores_format</span><span class="p">(</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Format the target and preds for multiclass inputs.</span>

<span class="sd">    Checks that the target and preds are of the same length and that the target</span>
<span class="sd">    and preds are of the correct shape. Converts the target and preds to the</span>
<span class="sd">    correct type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        num_classes: int</span>
<span class="sd">            The total number of classes for the problem.</span>
<span class="sd">        top_k: int</span>
<span class="sd">            The number of top predictions to consider when computing the statistics.</span>
<span class="sd">            Defaults to 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The formatted target and preds.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the target is not in binary (with maximum label &gt; 1) or multiclass</span>
<span class="sd">            format.</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If more unique values are detected in `target` than `num_classes`.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the predictions are not in multiclass or continuous-multioutput</span>
<span class="sd">            (logits or probabilites) format.</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If more unique values are detected in `preds` than `num_classes`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># convert target and preds to numpy arrays</span>
    <span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">type_target</span><span class="p">,</span> <span class="n">type_preds</span> <span class="o">=</span> <span class="n">common_input_checks_and_format</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">preds</span>
    <span class="p">)</span>

    <span class="c1"># check the target</span>
    <span class="k">if</span> <span class="n">type_target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;multiclass&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The argument `target` must be binary or multiclass, got </span><span class="si">{</span><span class="n">type_target</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="n">num_implied_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">num_implied_classes</span> <span class="o">&gt;</span> <span class="n">num_classes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Detected more unique values in `target` than `num_classes`. Expected only &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2"> but found </span><span class="si">{</span><span class="n">num_implied_classes</span><span class="si">}</span><span class="s2"> in `target`.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># check the preds</span>
    <span class="k">if</span> <span class="n">type_preds</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span> <span class="ow">and</span> <span class="n">num_classes</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">type_preds</span> <span class="o">=</span> <span class="s2">&quot;multiclass&quot;</span>
    <span class="k">if</span> <span class="n">type_preds</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;multiclass&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous-multioutput&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The argument `preds` must be multiclass or continuous multioutput, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">type_preds</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">type_preds</span> <span class="o">!=</span> <span class="s2">&quot;continuous-multioutput&quot;</span><span class="p">:</span>
        <span class="n">num_implied_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">preds</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">num_implied_classes</span> <span class="o">&gt;</span> <span class="n">num_classes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Detected more unique values in `preds` than `num_classes`. Expected &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;only </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2"> but found </span><span class="si">{</span><span class="n">num_implied_classes</span><span class="si">}</span><span class="s2"> in `preds`.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># check top_k</span>
    <span class="k">if</span> <span class="n">top_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_topk</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="n">type_preds</span><span class="p">,</span> <span class="n">type_target</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

    <span class="c1"># handle probabilities and logits</span>
    <span class="k">if</span> <span class="n">type_preds</span> <span class="o">==</span> <span class="s2">&quot;continuous-multioutput&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">preds</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">preds</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>  <span class="c1"># convert logits to probabilities</span>

    <span class="k">if</span> <span class="n">type_preds</span> <span class="o">==</span> <span class="s2">&quot;continuous-multioutput&quot;</span> <span class="ow">and</span> <span class="n">type_target</span> <span class="o">==</span> <span class="s2">&quot;multiclass&quot;</span><span class="p">:</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">select_topk</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">target</span><span class="p">]</span>  <span class="c1"># one-hot encoding</span>

    <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">preds</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_multiclass_stat_scores_update</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">classwise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Update the stat scores for multiclass inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        num_classes: int</span>
<span class="sd">            The total number of classes for the problem.</span>
<span class="sd">        top_k: int</span>
<span class="sd">            The number of top predictions to consider when computing the statistics.</span>
<span class="sd">            Defaults to ``None``.</span>
<span class="sd">        classwise: bool</span>
<span class="sd">            Whether to return the statistics for each class or sum over all classes.</span>
<span class="sd">            Defaults to ``False``.</span>
<span class="sd">        sample_weight: ArrayLike</span>
<span class="sd">            Sample weights.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The true positives, false positives, true negatives and false negatives.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the input target and preds are not numeric.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">target</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">_multiclass_stat_scores_format</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>

    <span class="n">reduce</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;macro&quot;</span> <span class="k">if</span> <span class="n">classwise</span> <span class="k">else</span> <span class="s2">&quot;micro&quot;</span>
    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_stat_scores</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="n">reduce</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span>


<span class="k">def</span> <span class="nf">_multiclass_stat_scores_compute</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">tp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute the stat scores for multiclass inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        tp: np.ndarray</span>
<span class="sd">            True positives.</span>
<span class="sd">        fp: np.ndarray</span>
<span class="sd">            False positives.</span>
<span class="sd">        tn: np.ndarray</span>
<span class="sd">            True negatives.</span>
<span class="sd">        fn: np.ndarray</span>
<span class="sd">            False negatives.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The true positives, false positives, true negatives and false negatives.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_stat_scores_compute</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>


<div class="viewcode-block" id="multiclass_stat_scores"><a class="viewcode-back" href="../../../../../reference/api/cyclops.evaluation.metrics.functional.stat_scores.html#cyclops.evaluation.metrics.functional.stat_scores.multiclass_stat_scores">[docs]</a><span class="k">def</span> <span class="nf">multiclass_stat_scores</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">classwise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute stat scores for multiclass inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        num_classes: int</span>
<span class="sd">            The total number of classes for the problem.</span>
<span class="sd">        top_k: int</span>
<span class="sd">            The number of top predictions to consider when computing the statistics.</span>
<span class="sd">            Defaults to ``None``.</span>
<span class="sd">        classwise: bool</span>
<span class="sd">            Whether to return the statistics for each class or sum over all classes.</span>
<span class="sd">            Defaults to ``False``.</span>
<span class="sd">        sample_weight: ArrayLike</span>
<span class="sd">            Sample weights.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The number of true positives, false positives, true negatives and false</span>
<span class="sd">        negatives.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_multiclass_stat_scores_update</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">preds</span><span class="p">,</span>
        <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
        <span class="n">classwise</span><span class="o">=</span><span class="n">classwise</span><span class="p">,</span>
        <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">_multiclass_stat_scores_compute</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_multilabel_stat_scores_format</span><span class="p">(</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">num_labels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Format the target and preds for multilabel inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        num_labels: int</span>
<span class="sd">            The total number of labels for the problem.</span>
<span class="sd">        threshold: float</span>
<span class="sd">            Threshold value for binarizing the predictions. Defaults to ``0.5``.</span>
<span class="sd">        top_k: int</span>
<span class="sd">            The number of top predictions to consider when computing the statistics.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The formatted target and preds.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the target is not in multilabel format.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the predictions are not in multilabel or continuous-multioutput</span>
<span class="sd">            (probabilities or logits) format.</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the number of labels implied by the predictions is inconsistent with</span>
<span class="sd">            ``num_labels``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">type_target</span><span class="p">,</span> <span class="n">type_preds</span> <span class="o">=</span> <span class="n">common_input_checks_and_format</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">preds</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">type_target</span> <span class="o">==</span> <span class="s2">&quot;multilabel-indicator&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The argument `target` must be multilabel-indicator, got </span><span class="si">{</span><span class="n">type_target</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">type_preds</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;multilabel-indicator&quot;</span><span class="p">,</span> <span class="s2">&quot;continuous-multioutput&quot;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The argument `preds` must be multilabel-indicator, or continuous &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;multioutput, got </span><span class="si">{</span><span class="n">type_preds</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="n">implied_num_labels</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">implied_num_labels</span> <span class="o">!=</span> <span class="n">num_labels</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="n">implied_num_labels</span><span class="si">}</span><span class="s2"> labels in `preds` but expected &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_labels</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">top_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_topk</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="n">type_preds</span><span class="p">,</span> <span class="n">type_target</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">type_preds</span> <span class="o">==</span> <span class="s2">&quot;continuous-multioutput&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">preds</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">preds</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">type_preds</span> <span class="o">==</span> <span class="s2">&quot;continuous-multioutput&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">top_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">select_topk</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">preds</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_multilabel_stat_scores_update</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">num_labels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reduce</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;samples&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;micro&quot;</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Update the stat scores for multilabel inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        num_labels: int</span>
<span class="sd">            The total number of labels for the problem.</span>
<span class="sd">        threshold: float</span>
<span class="sd">            Threshold value for binarizing the predictions. Defaults to ``0.5``.</span>
<span class="sd">        top_k: int</span>
<span class="sd">            The number of top predictions to consider when computing the statistics.</span>
<span class="sd">            Defaults to ``None``.</span>
<span class="sd">         reduce: str</span>
<span class="sd">            The reduction method to use. Defaults to ``&quot;micro&quot;``. Can be one of</span>
<span class="sd">                * ``&quot;micro&quot;`` - sum the statistics over all labels.</span>
<span class="sd">                * ``&quot;macro&quot;`` - compute the unweighted mean of the per-label</span>
<span class="sd">                statistics.</span>
<span class="sd">                * ``&quot;samples&quot;`` - compute the unweighted mean of the per-sample</span>
<span class="sd">                statistics.</span>
<span class="sd">        sample_weight: ArrayLike</span>
<span class="sd">            Sample weights.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The number of true positives, false positives, true negatives and false</span>
<span class="sd">        negatives.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the input target and preds are not numeric.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">target</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">_multilabel_stat_scores_format</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">top_k</span>
    <span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_labels</span><span class="p">)</span>

    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_stat_scores</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="n">reduce</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span>


<span class="k">def</span> <span class="nf">_multilabel_stat_scores_compute</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">tp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute the stat scores for multilabel inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        tp: np.ndarray</span>
<span class="sd">            The number of true positives.</span>
<span class="sd">        fp: np.ndarray</span>
<span class="sd">            The number of false positives.</span>
<span class="sd">        tn: np.ndarray</span>
<span class="sd">            The number of true negatives.</span>
<span class="sd">        fn: np.ndarray</span>
<span class="sd">            The number of false negatives.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The number of true positives, false positives, true negatives and false</span>
<span class="sd">        negatives.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_stat_scores_compute</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>


<div class="viewcode-block" id="multilabel_stat_scores"><a class="viewcode-back" href="../../../../../reference/api/cyclops.evaluation.metrics.functional.stat_scores.html#cyclops.evaluation.metrics.functional.stat_scores.multilabel_stat_scores">[docs]</a><span class="k">def</span> <span class="nf">multilabel_stat_scores</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">preds</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">num_labels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reduce</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;samples&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;micro&quot;</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute the stat scores for multilabel inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        target: ArrayLike</span>
<span class="sd">            Ground truth.</span>
<span class="sd">        preds: ArrayLike</span>
<span class="sd">            Predictions.</span>
<span class="sd">        num_labels: int</span>
<span class="sd">            The total number of labels for the problem.</span>
<span class="sd">        threshold: float</span>
<span class="sd">            Threshold value for binarizing the predictions. Defaults to ``0.5``.</span>
<span class="sd">        top_k: int</span>
<span class="sd">            The number of top predictions to consider when computing the statistics.</span>
<span class="sd">            Defaults to ``None``.</span>
<span class="sd">        reduce: Literal[&quot;micro&quot;, &quot;macro&quot;, &quot;samples&quot;]</span>
<span class="sd">            The reduction method to use. Defaults to ``&quot;micro&quot;``. Can be one of:</span>
<span class="sd">                - ``&quot;micro&quot;`` - sum the statistics over all labels.</span>
<span class="sd">                - ``&quot;macro&quot;`` - compute the unweighted mean of the per-label statistics.</span>
<span class="sd">                - ``&quot;samples&quot;`` - compute the unweighted mean of the per-sample</span>
<span class="sd">                    statistics.</span>
<span class="sd">        sample_weight: ArrayLike</span>
<span class="sd">            Sample weights.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The number of true positives, false positives, true negatives and false</span>
<span class="sd">        negatives and the support.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``reduce`` is not one of ``&quot;micro&quot;``, ``&quot;macro&quot;`` or ``&quot;samples&quot;``.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``threshold`` is not between ``0`` and ``1``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reduce</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;samples&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The argument `reduce` must be one of &#39;micro&#39;, &#39;macro&#39;, &#39;samples&#39;&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected argument `threshold` to be a float in the [0,1] range, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># pylint: disable=invalid-name</span>
    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">_multilabel_stat_scores_update</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">preds</span><span class="p">,</span>
        <span class="n">num_labels</span><span class="p">,</span>
        <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
        <span class="n">reduce</span><span class="o">=</span><span class="n">reduce</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
        <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">_multilabel_stat_scores_compute</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Vector AI Engineering.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>